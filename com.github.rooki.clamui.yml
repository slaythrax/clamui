app-id: com.github.rooki.clamui
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: clamui

finish-args:
  # Read-only access to host filesystem for scanning files
  - --filesystem=host:ro
  # Read-write access to ClamAV database directory for updates
  - --filesystem=/var/lib/clamav:rw
  # D-Bus session access for desktop integration
  - --socket=session-bus
  # X11 display access
  - --socket=x11
  # Wayland display access
  - --socket=wayland
  # GPU acceleration
  - --device=dri
  # Desktop icons and themes
  - --share=ipc
  # Network access for virus database updates
  - --share=network

modules:
  - name: json-c
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://s3.amazonaws.com/json-c_releases/releases/json-c-0.18.tar.gz
        sha256: 876ab046479166b869afc6896d288183bbc0e5843f141200c677b3e8dfb11724

  - name: clamav
    buildsystem: cmake-ninja
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/clamav/cargo
    config-opts:
      - -DENABLE_CLAMONACC=OFF
      - -DENABLE_MILTER=OFF
      - -DENABLE_EXAMPLES=OFF
      - -DENABLE_MAN_PAGES=OFF
      - -DENABLE_TESTS=OFF
      - -DENABLE_SYSTEMD=OFF
    sources:
      - type: archive
        url: https://www.clamav.net/downloads/production/clamav-1.3.1.tar.gz
        sha256: 12a3035bf26f55f71e3106a51a5fa8d7b744572df98a63920a9cff876a7dcce4
        x-checker-data:
          type: anitya
          project-id: 13023
          url-template: https://www.clamav.net/downloads/production/clamav-$version.tar.gz

  - name: clamui
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=/app --no-deps .
      - install -Dm644 com.github.rooki.clamui.desktop /app/share/applications/com.github.rooki.clamui.desktop
      - install -Dm644 icons/com.github.rooki.clamui.svg /app/share/icons/hicolor/scalable/apps/com.github.rooki.clamui.svg
    sources:
      - type: dir
        path: .
