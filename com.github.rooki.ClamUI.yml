app-id: com.github.rooki.ClamUI
runtime: org.gnome.Platform
runtime-version: '47'
sdk: org.gnome.Sdk
command: clamui

finish-args:
  # Graphics - Wayland and X11 fallback
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri

  # File access for scanning user files
  - --filesystem=home

  # Host binary access for ClamAV (flatpak-spawn --host)
  - --talk-name=org.freedesktop.Flatpak

  # Notifications for scan completion
  - --socket=session-bus

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - '*.la'
  - '*.a'

modules:
  - name: clamui
    buildsystem: simple
    build-commands:
      # Install Python source package directly (pure Python - no build required)
      # PyGObject is provided by the GNOME SDK, so no additional dependencies needed
      - |
        PYTHON_VERSION=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
        SITE_PACKAGES="/app/lib/python${PYTHON_VERSION}/site-packages"
        mkdir -p "${SITE_PACKAGES}"
        cp -r src "${SITE_PACKAGES}/"

      # Create launcher script
      - |
        mkdir -p /app/bin
        cat > /app/bin/clamui << 'LAUNCHER'
        #!/usr/bin/env python3
        """ClamUI launcher script for Flatpak."""
        import sys
        import os

        # Ensure the app's site-packages is in the path
        app_lib = '/app/lib'
        for entry in os.listdir(app_lib):
            if entry.startswith('python3'):
                site_pkg = os.path.join(app_lib, entry, 'site-packages')
                if os.path.isdir(site_pkg) and site_pkg not in sys.path:
                    sys.path.insert(0, site_pkg)
                    break

        from src.main import main
        sys.exit(main())
        LAUNCHER
        chmod +x /app/bin/clamui

      # Install desktop entry
      - install -Dm644 com.github.rooki.ClamUI.desktop -t /app/share/applications/

      # Install AppStream metadata
      - install -Dm644 com.github.rooki.ClamUI.metainfo.xml -t /app/share/metainfo/

      # Install icon (use GNOME's built-in security icon as fallback)
      - |
        mkdir -p /app/share/icons/hicolor/scalable/apps/
        if [ -f "icons/com.github.rooki.ClamUI.svg" ]; then
          install -Dm644 icons/com.github.rooki.ClamUI.svg /app/share/icons/hicolor/scalable/apps/com.github.rooki.ClamUI.svg
        fi

    sources:
      - type: dir
        path: .
